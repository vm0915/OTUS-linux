Project

1. Wordpress installation

sudo su
yum install -y wget
wget http://wordpress.org/latest.tar.gz

tar -xzvf latest.tar.gz

===Config mysqlserver===

cd wordpress/
cp wp-config-sample.php wp-config.php

yum install -y epel-release
yum install -y nginx
systemctl enable --now nginx

copy wordpress /usr/share/nginx/html

yum isntall -y php-fpm
systemctl enable --now php-fpm.service

sudo nginx -t
sudo systemctl reload nginx


===nginx.conf===

worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;
  index index.php index.html;
  location / {
    # This is cool because no php is touched for static content.
    try_files $uri $uri/ /index.php;
  }
  location ~* \.(jpg|jpeg|gif|css|png|js|ico|html)$ {
    expires max;
  }
  location ~* \.php$ {
    try_files $uri =404
    fastcgi_intercept_errors on;
    fastcgi_index   index.php;
    fastcgi_pass    127.0.0.1:9000;
    include fastcgi_params;
    fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
    fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
  }
  location ~ /\.(ht|ssh) {
    deny  all;
  }
  location /status {
    include fastcgi_params;
    fastcgi_pass    127.0.0.1:9000;
  }
}
}
                        
=====================================

sudo yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm
sudo yum install yum-utils
sudo yum-config-manager --disable remi-php54
sudo yum-config-manager --enable remi-php73
yum update php-fpm

yum install php-mysql


===Create certificate===
mkdir /etc/ssl/private
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt

===edit nginx config===
listen 443 ssl default_server;
        ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
        ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;


===/etc/php-fpm.d/www.conf===
[www]
listen = /var/run/php-fpm/php-fpm.sock
listen.allowed_clients = 127.0.0.1
listen.owner = nginx
listen.group = nginx
listen.mode = 0666
user = nginx
group = nginx
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
slowlog = /var/log/php-fpm/www-slow.log
php_admin_value[error_log] = /var/log/php-fpm/www-error.log
php_admin_flag[log_errors] = on
php_value[session.save_handler] = files
php_value[session.save_path] = /var/lib/php/session


2. MySQL installation

yum install -y mariadb-server
sudo systemctl enable --now mariadb
sudo systemctl status mariadb

sudo mysql_secure_installation

check if installation is ok:
mysqladmin -u root -p version 

mysql -u root -p
CREATE DATABASE wordpress;
GRANT ALL PRIVILEGES ON wordpress.* TO "wordpress"@"192.168.30.2" IDENTIFIED BY "wordpress";
FLUSH PRIVILEGES;
EXIT




4. Router config

sysctl net.ipv4.conf.all.forwarding=1
echo "net.ipv4.conf.all.forwarding=1" > /etc/sysctl.d/10-net.conf
echo "DEFROUTE=no" >> /etc/sysconfig/network-scripts/ifcfg-eth0 
systemctl restart network

ip route delete default
ip route add default via 192.168.10.10
	
# маскарад для внутренней сети
iptables -t nat -A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE

# проброс порта к nginx
iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to 192.168.30.2:80
iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 443 -j DNAT --to 192.168.30.2:443
# iptables -t nat -A POSTROUTING  -p tcp --dst 192.168.30.2 --dport 80 -j SNAT --to-source 192.168.30.1
# iptables -t nat -A POSTROUTING  -p tcp --dst 192.168.30.2 --dport 443 -j SNAT --to-source 192.168.30.1

iptables -A INPUT -i eth1 -p tcp -m tcp -m multiport ! --dports 80,443 -j DROP





нужно удалить маршрут на server nginx
ip route del 192.168.10.0/24


===iptables-save===

# Generated by iptables-save v1.4.21 on Mon Jan 25 12:48:26 2021
*filter
:INPUT ACCEPT [678:37365]
:FORWARD ACCEPT [576:371977]
:OUTPUT ACCEPT [431:40711]
-A INPUT -i eth1 -p tcp -m tcp -m multiport ! --dports 80,443 -j DROP
COMMIT
# Completed on Mon Jan 25 12:48:26 2021
# Generated by iptables-save v1.4.21 on Mon Jan 25 12:48:26 2021
*nat
:PREROUTING ACCEPT [5650:330716]
:INPUT ACCEPT [41:5212]
:OUTPUT ACCEPT [25:3539]
:POSTROUTING ACCEPT [153:8996]
-A PREROUTING -i eth1 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.30.2:80
-A PREROUTING -i eth1 -p tcp -m tcp --dport 443 -j DNAT --to-destination 192.168.30.2:443
-A PREROUTING -i eth1 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.30.2:80
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT


======


# маршрут между внутренними сетями




openssl req -x509 -nodes -subj '/CN=test' -days 365 -newkey rsa:2048 -sha256 -keyout key.test -out cert.test creates=cert.test


setsebool -P httpd_can_network_connect_db 1



net.ipv4.conf.all.forwarding = 1
прописать маршрут к вагрант-роутеру через хостовую для виртуалок машину
отключить фаервол на хостовой машине


ansible-galaxy collection install ansible.posix       ===================================================
ansible-galaxy collection install community.general


=======ansible iptables=======
-A INPUT -i eth1 -p tcp -m tcp -m multiport ! --dports 80,443 -j DROP

 - name: ansible rule 1
   iptables:
     chain: INPUT
	 in_interface: eth1
	 protocol: tcp
	 



==================new 28.01
 
 ===1.
 policycoreutils-python-utils
 setroubleshoot-server 
setsebool -P httpd_can_connect_zabbix on
setsebool -P httpd_can_network_connect_db on 
 
sed 's/#.*$//;/^$/d'
 
 ip route add 1.0.4.4/32 via 192.168.40.1
zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -h 192.168.30.3 -u zabbix -p zabbix
 
systemctl restart zabbix-server zabbix-agent nginx php-fpm
systemctl enable zabbix-server zabbix-agent nginx php-fpm


yum install -y policycoreutils-python-utils



setsebool -P httpd_can_connect_zabbix on
setsebool -P httpd_can_network_connect_db on 
systemctl start zabbix-server.service
ausearch -c 'zabbix_server' --raw | audit2allow -M my-zabbixserver
semodule -X 300 -i my-zabbixserver.pp
 

 
 /etc/php.ini
 date.timezone = Europe/Moscow
 systemctl restart php-fpm.service
 
 Admin/zabbix
 

 триггер
 
 {Linux gitlab-latest.dev.rus 4.4.246-1.el7.elrepo.x86_64 _1 SMP Tue Nov 24 09_26_59 EST 2020 x86_64:web.test.rspcode[Availiability of gitlab,Home page].last(#2)}>=400




